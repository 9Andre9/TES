<template>
  <div class="container">
    <div class="alert alert-danger" role="alert" v-if="error !== ''">
      {{ error }}
    </div>
    <div class="row">
      <h2>Room: {{ room_name }}</h2>
    </div>
    <div class="row clearfix">
      <div class="col-lg-3 chat-frame">
        <MemberList :room_id="room_id" :users_info="users_info" @on-error="on_error"
                    @on-user-change="on_user_change"/>
      </div>
      <div class="col-lg-9 chat-frame">
        <h4>Chat</h4>
        <ChatComponent :users_info="users_info"/>
      </div>
    </div>
  </div>
</template>

<script lang="ts">
import { defineComponent } from 'vue'
import MemberList from '@/components/MemberList.vue'
import { mapActions, mapGetters } from 'vuex'
import { MatrixRoomMemberStateEvent } from '@/interface/rooms_event.interface'
import ChatComponent from '@/components/ChatComponent.vue'
import { RoomUserInfo } from '@/models/user.model'

export default defineComponent({
  name: 'RoomDetail',
  data () {
    return {
      users_info: [] as Array<RoomUserInfo>,
      room_name: '' as string,
      error: '' as string
    }
  },
  computed: {
    ...mapGetters('rooms', [
      'get_member_state_events_for_room',
      'get_permission_event_for_room',
      'get_room_name'
    ]),
    ...mapGetters('user', [
      'get_users_info_for_room'
    ]),
    room_id (): string {
      return this.$route.params.room_id as string
    }
  },
  components: {
    ChatComponent,
    MemberList
  },
  methods: {
    ...mapActions('rooms', [
      'action_get_room_state_events'
    ]),
    ...mapActions('tx', [
      'action_create_mock_tx'
    ]),
    ...mapActions('chat', [
      'action_create_mock_chat'
    ]),
    async update_member_list () {
      try {
        await this.action_get_room_state_events({
          room_id: this.room_id
        })
        this.room_name = this.get_room_name(this.room_id)
        this.users_info = this.get_users_info_for_room(this.room_id)
      } catch (e) {
        alert('Room does not exist or you are not part of the room!')
        this.$router.push({
          name: 'rooms'
        })
      }
    },
    on_error (error: string) {
      this.error = error
    },
    on_user_change () {
      this.update_member_list()
    }
  },
  async mounted () {
    await this.update_member_list()
    await this.action_create_mock_tx({
      room_id: this.room_id
    })
    await this.action_create_mock_chat({
      room_id: this.room_id
    })
  }
})
</script>
<style scoped>
.chat-frame {
  left: 0;
  top: 0;
  padding: 20px;
}

.chat-frame {
  -moz-transition: .5s;
  -o-transition: .5s;
  -webkit-transition: .5s;
  transition: .5s
}
</style>
